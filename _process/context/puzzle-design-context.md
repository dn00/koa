# Puzzle Design Context Briefing

**Purpose:** Essential context for any agent working on puzzle design, mechanic tuning, or invariant definition. Read this BEFORE proposing changes.

**Last Updated:** 2026-01-27

---

## The Game in 30 Seconds

"Home Smart Home" is a daily puzzle card game. You're a homeowner trying to convince KOA (a snarky AI owl home assistant) that you didn't commit a petty domestic "crime" (raiding the fridge at 2am, changing the thermostat, etc.). You have 6 evidence cards and must build a testimony across turns. KOA cross-examines you with counters, catches contradictions, and narrates with comedy. 3-12 minute sessions, casual players, mobile-first.

---

## Current Mechanic State (from D31 — canonical)

### Cards
- **6 dealt cards** per puzzle (no draft, no draw, same for all players)
- Cards are **per-puzzle** (generated by LLM pipeline), NOT from a shared pool
- Each card has: power (1-20), ProofType(s), claims (location, state, activity, timeRange), flavor text
- **Refutation cards** are a subset of the hand — they nullify KOA's counters, have power, but have NO claims (can never contradict)
- **Max 1 trap card** per hand (high power, claims conflict with main path)
- Trust tiers: VERIFIED (+0 scrutiny), PLAUSIBLE (+0), SKETCHY (+1 scrutiny on use)

### Turn Structure
1. SELECT 1-3 cards
2. PREVIEW shows: concerns addressed, contradictions, counter response, projected damage
3. SUBMIT (confirm)
4. RESOLUTION: contradiction check -> counter -> damage -> concern updates -> committed story

**Note:** There IS a pre-submission preview in the current design. The proposed "Testimony Lock" mechanic would REMOVE this preview, making the player commit blind. This has NOT been implemented yet — it's in the ideas parking lot.

### Damage Formula
```
For each card:
  card_damage = card.power
  if counter targets this card's ProofType AND not refuted:
    card_damage = ceil(card_damage * 0.5)  // contested penalty

total = sum of card damages
if 2+ cards share same claim value (location/state/activity):
  total = ceil(total * 1.25)  // corroboration bonus

resistance -= total
```

### Counters (KOA)
- 2-3 per puzzle
- Target **ProofTypes** (not specific cards) — design doc says ProofType, engine code currently uses CardId (known mismatch, engine-core-hardening task exists)
- At most ONE counter fires per turn (first applicable, stable ordering)
- All affected cards in submission take 50% penalty (ceil)
- **Retroactive refutation:** playing a refutation card spends the counter AND restores previously-contested damage
- **Visibility modes:** FULL (default, all counters visible from turn 1) or HIDDEN (revealed when triggered)

### Contradictions
- **MAJOR:** submission blocked entirely (cannot submit)
- **MINOR:** +1 scrutiny, submission allowed
- State conflicts: ASLEEP<->AWAKE is MAJOR (<3min), MINOR (3-10min), NONE (>10min)
- DROWSY<->ALERT: MINOR (<5min), NONE (>5min)
- IDLE<->ACTIVE: always NONE
- Location conflicts: time-gap thresholds per location pair (e.g., BEDROOM<->KITCHEN: MAJOR <30s, MINOR 30s-2min, NONE >2min)

### Corroboration
- Triggers when 2+ cards in SAME submission share a claim value (location, state, or activity)
- Bonus: total damage x 1.25 (after contested penalties, rounded up)

### Scrutiny
- Range: 0-5 integer
- Sources: MINOR contradiction (+1), SKETCHY trust card (+1)
- Scrutiny 5 = immediate loss
- No recovery mechanism

### Win/Loss
- **Win:** resistance <= 0 AND all concerns addressed (within turn budget)
- **Lose:** turns exhausted OR scrutiny reaches 5

---

## Existing Solvability Constraints (from D10)

These are ALREADY enforced by the puzzle validator:

| ID | Constraint |
|----|------------|
| S1 | All concerns addressable with dealt hand |
| S2 | Total hand power >= resistance + 10 (comfortable margin) |
| S3 | At least 2 meaningfully distinct winning paths |
| S4 | Max 1 trap card |
| S5 | Refutation exists for primary counter OR puzzle winnable despite contest |
| C1 | No forced MAJOR contradictions in any winning path |
| C2 | Optimal path scrutiny <= 3 |
| F8 | At least 3 cards in every hand must be pairwise-compatible |

---

## Difficulty Tuning Table

| Difficulty | Cards | Concerns | Resistance | Counters | Traps | Turns |
|------------|-------|----------|------------|----------|-------|-------|
| Tutorial   | 4     | 2        | 20         | 1        | 0     | 5     |
| Easy       | 5     | 2        | 25         | 2        | 0     | 5     |
| Normal     | 6     | 3        | 35         | 2        | 1     | 6     |
| Hard       | 6     | 3        | 45         | 3        | 1     | 6     |
| Expert     | 6     | 4        | 50         | 3        | 1     | 6     |

**Win rate targets:** Tutorial 90%+, Easy 80%+, Normal 65%+, Hard 45%+, Expert 30%+

---

## Content Pipeline

- All dialogue is **LLM-generated at puzzle creation time** and shipped in puzzle packs
- Each puzzle pack includes **41 pre-generated testimony combinations** (6 singles + 15 pairs + 20 triples) with player testimony line, KOA response, mood state, and mechanics
- Puzzle packs are self-contained JSON (<= 300KB)
- No LLM calls at runtime — resolver is pure deterministic functions

---

## Weekly Puzzle Variety (6 Archetypes)

Rotated weekly to prevent staleness:
1. **Trap** — tempting high-power card that contradicts
2. **Scrutiny (push-your-luck)** — accepting MINORs is sometimes optimal
3. **Counter-heavy** — multiple counters, refutation sequencing matters
4. **Eat-the-contest** — accepting contested penalty is better than wasting turns refuting
5. **Tight margins** — every point matters
6. **Corroboration** — hidden synergies between cards

---

## Invariants (from D31-INVARIANTS — non-negotiable)

### Product Invariants
- I1: Daily puzzle, same for everyone
- I2: 2-10 minute sessions
- I3: Mobile-first, offline-capable
- I4: Casual-friendly, not punishing

### Design Invariants
- I5: Always winnable (no impossible puzzles)
- I6: No hidden gotchas (FULL mode default — player sees all counter info)
- I7: Mistakes are recoverable (1-2 MINORs shouldn't lose the game)
- I8: Skill must matter (better play = better score, not just win/lose)
- I9: Multiple viable paths (at least 2 distinct winning strategies)
- I10: Must feel original (not "just another card game")

### Mechanical (all tunable)
- Card count, concerns, resistance, turns, contradiction thresholds, counter mechanics — all adjustable via playtesting

---

## Open Design Questions (not yet decided)

1. **Testimony Lock:** Remove the pre-submission preview? Creates Wordle-like blind commit. Approved for exploration, not committed.
2. **Verdict Scale:** Replace binary win/lose with 4-tier outcome? Labels TBD (NOT court-themed). Approved for exploration.
3. **Reactive KOA:** Counters deploy in response to plays via decision tree, not visible upfront? Would replace FULL/HIDDEN toggle.
4. **Simplified contradiction rules:** Reduce to ~5 memorizable principles instead of per-location-pair thresholds?
5. **Card pool model:** Per-puzzle (current) vs shared pool (like Balatro)? Current design is per-puzzle.
6. **More contradiction axes:** Currently only ASLEEP/AWAKE matters. Need DROWSY/ALERT, state/activity interactions?

---

## What Agents Got Wrong (Batch 1+2 findings to correct)

1. Agents assumed Testimony Lock was already in place — it's NOT, it's proposed
2. Agents recommended razor-thin margins — but S2 says power >= resistance + 10
3. Agents assumed shared card pool — cards are per-puzzle
4. Agents assumed counters target CardId — design says ProofType (code mismatch exists)
5. Agents assumed refutation cards have claims — they don't (can never contradict)
6. Agents assumed scrutiny is a dead threat — with more contradiction axes it could be real
7. Some agent invariants conflict with I6 (no hidden gotchas) and I7 (mistakes recoverable)

---

## KOA Character Notes

- Passive-aggressive bureaucrat. DMV clerk meets psychic therapist.
- Never angry, always "concerned"
- Uses your own data against you
- 8 mood states: NEUTRAL, CURIOUS, SUSPICIOUS, BLOCKED, GRUDGING, IMPRESSED, RESIGNED, SMUG
- Comedy comes from forensic intensity applied to domestic triviality
- Banned words: any courtroom language (objection, verdict, guilty, etc.)
- All lines must pass: screenshot test, read-aloud test, skip test, personality test
- Under 2 sentences per beat

---

## Key Doc References

| Doc | What It Contains |
|-----|-----------------|
| D31 | Core mechanics (CANONICAL) |
| D31-INVARIANTS | Non-negotiable constraints |
| D03 | Resolver spec (deterministic pipeline) |
| D04 | Concerns & counter-evidence library |
| D09 | Pack schemas (JSON format) |
| D10 | Solvability validation rules |
| D00 | Product blueprint |
| D02 | Game loop & run structure |
| D05 | Moves & tokens spec |
