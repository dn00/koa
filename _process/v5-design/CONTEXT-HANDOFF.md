# KOA Casefiles - Context Handoff

## Project: Emergent Detective Simulation
A cozy, comedic detective game where players solve daily mysteries generated by a deep deterministic simulation. "Knives Out meets Animal Crossing."

---

## ðŸ“… Current Status
**Core Simulation & Emergent Systems Complete.**
The validation stack runs, generates cases with 96% validity, and features a fully emergent gossip ecology where character relationships and motives evolve over time.

### âœ… What is Done
1. **Deterministic Simulation Engine** (`src/sim.ts`)
   - Simulates NPC routines, locations, and interactions tick-by-tick.
   - Deterministic event log generation for validatable replayability.
   - Core world model (5 rooms, 5 NPCs, 12 items).

2. **Emergent Comedy & Variety**
   - **12 Items:** Distributed across all rooms (Kitchen, Living, Bedroom, Office, Garage).
   - **Distracted Witnesses:** Simulation handles NPCs who are present but "distracted" (sleeping, on phone), allowing for more crime opportunities.
   - **Variety Analysis:** 128+ unique combos, days-to-repeat > 64.

3. **Deep Simulation (Active Red Herrings)** (`sim.ts`, `activities.ts`)
   - **True Activity Simulation:** NPCs perform actual tasks when idle (e.g., "Snacking", "Reading Fanfic", "Looking for contact lens").
   - **Evidence Trails:** Activities generate `TRACE_FOUND` (crumbs) and `AUDIO_AT_LOCATION` (chewing sounds) events.
   - **No Templates:** The system is fully emergent. Witnesses describe what they *heard*, searching reveals *traces*.
   - **Comedy Injection:** `CrimeMethod` is generated pre-execution, ensuring the crime itself has the same comedic flavor as the red herrings.

4. **Emergent Gossip Ecology** (`src/gossip/`)
   - **True Emergence:** Motives are no longer templates. They are derived from simulated history.
   - **Pre-Simulation:** Runs 200 ticks of background life before each case to evolve relationships.
   - **Dynamic Relationships:** Proximity and rumors shift affinities (0-100).
   - **Gossip Propagation:** Events spawn rumors that spread through the house network.
   - **History & Grudges:** Tracks past cases; wrongly accused NPCs hold grudges that drive future crimes.

### ðŸ“Š Validation Stats (After Polish)
- **Pass Rate:** 97.7% (Target: 95%)
- **Valid Seeds:** 977/1000
- **Cold Start:** Fixed via 30-day synthetic pre-simulation.
- **Accessibility:** Garage items up to 7.5% usage.
- **Motive Variety:** Emergent "Revenge" (77%) and "Chaos" (15%) dominate, driven by simulated history.

### âš ï¸ Remaining Nuances
- **Bob's Culprit Rate:** ~6.6% (Low but non-zero).
- **Bedroom Items:** ~1.8% (Shared room makes theft hard).
- **Revenge Dominance:** 77% of cases are revenge-driven (due to high grudge generation in history). This is "working as intended" for emergence, but could be tuned.

---

## ðŸ“‚ Key Files
- `src/sim.ts` - Main entry point. orchestrates Pre-Sim -> Crime -> Post-Sim.
- `src/gossip/` - The emergent brain.
  - `motives.ts` - Derives "Why" from state (Grudge > Rumor > Affinity).
  - `rumors.ts` - Handles gossip spawning and spreading.
  - `history.ts` - Tracks long-term memory (grudges/alliances).
- `src/world.ts` - Static world definition (Room graph, Items, NPC schedules).
- `src/validators.ts` - Ensures cases are solvable and fair (alibi checks).

---

## ðŸš€ Next Steps (Phase 12)
The simulation is ready. Now we need the **Player Layer**.

1. **Player Action Executor** (`src/actions.ts`)
   - Implement `Interview`, `Search`, `CheckLog`, `CrossReference`.
   - Logic for revealing hidden info based on AP cost.

2. **Player State Manager** (`src/player.ts`)
   - Track AP (Action Points).
   - Manage "Evidence Bag" (what the player knows vs what exists).

3. **KOA Presenter** (`src/koa/`)
   - The "Voice" of the game.
   - Translate raw JSON events into cheeky AI dialogue.
   - "I saw Bob in the kitchen" -> "Bob was seen lurking near the sourdough at 7:15pm."

4. **Game Loop**
   - Tie it all together: Init -> Daily Turn -> Action -> Feedback -> Accusation.
